FROM node:16-alpine AS base

# RUN apk update

## Globally install turbo

RUN npm i -g turbo@1.5.4

# Prune the workspace for the `@woi/principal-dashboard` app

FROM base as pruner
WORKDIR /app
COPY . .
RUN turbo prune --scope=@woi/principal-dashboard --docker

# Add pruned lockfile and package.json's of the pruned subworkspace

FROM base AS installer
WORKDIR /app
COPY --from=pruner /app/out/json/ .
COPY --from=pruner /app/out/yarn.lock ./yarn.lock

# Install only the deps needed to build the target

RUN yarn install --verbose --ignore-platform --ignore-engines --check-files --frozen-lockfile

# Copy source code of pruned subworkspace and build

FROM base as builder
WORKDIR /app
COPY --from=pruner /app/out/full/ .
COPY --from=installer /app/ .
RUN turbo run build --scope=@woi/principal-dashboard --include-dependencies --no-deps

# Start the app

FROM builder as runner
EXPOSE 3000
CMD ["yarn", "--cwd", "apps/principal-dashboard", "start"]
